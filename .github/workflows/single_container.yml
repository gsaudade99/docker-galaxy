name: Single Container Test
on: [push, pull_request]
jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Build and Test
      env:
        KEEP_IMAGE: ${{ github.event_name == 'pull_request' }}
      run: bash .github/workflows/single.sh
    - name: Prepare image artifact
      if: github.event_name == 'pull_request'
      id: image
      run: |
        set -euo pipefail
        pr_number="${{ github.event.pull_request.number }}"
        head_sha="${{ github.event.pull_request.head.sha }}"
        short_sha="${head_sha:0:7}"
        image_tag="galaxy:pr-${pr_number}-${short_sha}"
        docker tag quay.io/bgruening/galaxy "${image_tag}"
        echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
        echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"
    - name: Split image for upload
      if: github.event_name == 'pull_request'
      run: |
        set -euo pipefail
        docker save "${{ steps.image.outputs.image_tag }}" -o galaxy-image.tar
        split -n 4 -d -a 2 galaxy-image.tar galaxy-image.tar.part-
        cat > ci-image.json <<EOF
        {
          "image": "${{ steps.image.outputs.image_tag }}",
          "parts_prefix": "galaxy-image.tar.part-",
          "parts_expected": 4,
          "workflow": "single_container.yml",
          "run_id": "${GITHUB_RUN_ID}",
          "sha": "${{ steps.image.outputs.short_sha }}",
          "pr": "${{ github.event.pull_request.number }}"
        }
        EOF
    - name: Upload image metadata
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: galaxy-image-${{ github.event.pull_request.number }}-meta
        path: ci-image.json
        retention-days: 2
    - name: Upload image part 00
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: galaxy-image-${{ github.event.pull_request.number }}-part-00
        path: galaxy-image.tar.part-00
        retention-days: 2
    - name: Upload image part 01
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: galaxy-image-${{ github.event.pull_request.number }}-part-01
        path: galaxy-image.tar.part-01
        retention-days: 2
    - name: Upload image part 02
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: galaxy-image-${{ github.event.pull_request.number }}-part-02
        path: galaxy-image.tar.part-02
        retention-days: 2
    - name: Upload image part 03
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: galaxy-image-${{ github.event.pull_request.number }}-part-03
        path: galaxy-image.tar.part-03
        retention-days: 2
