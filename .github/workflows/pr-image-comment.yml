name: Image Artifact Helper

on:
  issue_comment:
    types: [created]

jobs:
  fetch_artifacts:
    if: github.event.issue.pull_request && contains(toLower(github.event.comment.body), '@bot please fetch artefacts')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      issues: write
      pull-requests: read
    steps:
      - name: Find latest successful image build
        id: run
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.issue.number;
            const workflowId = 'single_container.yml';

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              event: 'pull_request',
              per_page: 50,
            });

            const run = runs.data.workflow_runs.find((r) =>
              r.conclusion === 'success' &&
              r.pull_requests &&
              r.pull_requests.some((pr) => pr.number === prNumber)
            );

            if (!run) {
              core.setOutput('run_id', '');
              core.setOutput('run_url', '');
              core.setOutput('head_sha', '');
              return;
            }

            core.setOutput('run_id', String(run.id));
            core.setOutput('run_url', run.html_url);
            core.setOutput('head_sha', run.head_sha);

      - name: Comment when image is missing
        if: steps.run.outputs.run_id == ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.issue.number;
            const body = [
              'No successful `single_container.yml` run found for this PR yet.',
              'Please wait for CI to finish and comment again.',
            ].join('\n');
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });

      - name: Comment with artifact instructions
        if: steps.run.outputs.run_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.issue.number;
            const runId = '${{ steps.run.outputs.run_id }}';
            const runUrl = '${{ steps.run.outputs.run_url }}';
            const headSha = '${{ steps.run.outputs.head_sha }}';
            const shortSha = headSha.substring(0, 7);
            const imageTag = `galaxy:pr-${prNumber}-${shortSha}`;
            const artifactPrefix = `galaxy-image-${prNumber}-part-`;
            const parts = ['00', '01', '02', '03'];
            const downloads = parts.map((p) => `gh run download ${runId} -n ${artifactPrefix}${p}`).join('\n');

            const body = [
              'CI image artifacts are available for this PR:',
              `- Run: ${runUrl}`,
              '',
              'Download and reassemble:',
              '```bash',
              downloads,
              'cat galaxy-image.tar.part-* > galaxy-image.tar',
              'docker load -i galaxy-image.tar',
              `docker run --rm -p 8080:80 ${imageTag}`,
              '```',
              '',
              'Note: artifacts are retained for 48 hours.',
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });

  build_on_request:
    if: contains(toLower(github.event.comment.body), '@bot please build ')
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Parse build request
        id: request
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const body = context.payload.comment.body;
            const match = body.match(/@bot\s+please\s+build\s+(https:\/\/github\.com\/[^\s]+\/galaxy\/archive\/[^\s]+?\.(zip|tar\.gz))/i);

            if (!match) {
              core.setOutput('requested', 'false');
              return;
            }

            const association = context.payload.comment.author_association;
            const allowed = ['OWNER', 'MEMBER', 'COLLABORATOR'];
            const isPr = !!context.payload.issue.pull_request;
            const repoInfo = await github.rest.repos.get({ owner, repo });

            let checkoutRef = '';
            if (isPr) {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: issueNumber });
              checkoutRef = pr.data.head.sha;
            } else {
              checkoutRef = repoInfo.data.default_branch;
            }

            core.setOutput('requested', 'true');
            core.setOutput('authorized', allowed.includes(association) ? 'true' : 'false');
            core.setOutput('url', match[1]);
            core.setOutput('issue_number', String(issueNumber));
            core.setOutput('is_pr', isPr ? 'true' : 'false');
            core.setOutput('checkout_ref', checkoutRef);
            core.setOutput('base_branch', repoInfo.data.default_branch);

      - name: Comment when request is invalid
        if: steps.request.outputs.requested != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const body = [
              'Build request format not recognized.',
              'Usage: `@bot please build https://github.com/<owner>/galaxy/archive/refs/heads/<branch>.zip`',
              'Or: `@bot please build https://github.com/<owner>/galaxy/archive/<commit>.tar.gz`',
            ].join('\n');
            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body });

      - name: Checkout request branch
        if: steps.request.outputs.requested == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.request.outputs.checkout_ref }}
          fetch-depth: 1

      - name: Set up Docker Buildx
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Set image tag
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        id: imagetag
        run: |
          set -euo pipefail
          issue_number="${{ steps.request.outputs.issue_number }}"
          short_sha="$(git rev-parse --short HEAD)"
          if [[ "${{ steps.request.outputs.is_pr }}" == "true" ]]; then
            image_tag="galaxy:pr-${issue_number}-${short_sha}"
          else
            image_tag="galaxy:issue-${issue_number}-${short_sha}"
          fi
          echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"

      - name: Prepare build args
        if: steps.request.outputs.requested == 'true'
        id: buildargs
        run: |
          set -euo pipefail
          source_url="${{ steps.request.outputs.url }}"
          source_url="${source_url%%\?*}"
          source_url="${source_url%.zip}"
          source_url="${source_url%.tar.gz}"
          case "$source_url" in
            https://github.com/*/galaxy/archive/*) ;;
            *)
              echo "Unsupported source URL: $source_url" >&2
              exit 1
              ;;
          esac
          repo_path="${source_url#https://github.com/}"
          repo_path="${repo_path%%/archive/*}"
          release="${source_url#https://github.com/${repo_path}/archive/}"
          galaxy_repo="https://github.com/${repo_path}"
          echo "galaxy_repo=${galaxy_repo}" >> "$GITHUB_OUTPUT"
          echo "galaxy_release=${release}" >> "$GITHUB_OUTPUT"

      - name: Build image
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        run: |
          set -euo pipefail
          docker buildx build \
            --load \
            --build-arg GALAXY_REPO="${{ steps.buildargs.outputs.galaxy_repo }}" \
            --build-arg GALAXY_RELEASE="${{ steps.buildargs.outputs.galaxy_release }}" \
            -t "${{ steps.imagetag.outputs.image_tag }}" \
            galaxy/

      - name: Split image and upload artifacts
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        run: |
          set -euo pipefail
          docker save "${{ steps.imagetag.outputs.image_tag }}" -o galaxy-image.tar
          split -n 4 -d -a 2 galaxy-image.tar galaxy-image.tar.part-
          cat > ci-image.json <<EOF
          {
            "image": "${{ steps.imagetag.outputs.image_tag }}",
            "galaxy_repo": "${{ steps.buildargs.outputs.galaxy_repo }}",
            "galaxy_release": "${{ steps.buildargs.outputs.galaxy_release }}",
            "parts_prefix": "galaxy-image.tar.part-",
            "parts_expected": 4,
            "run_id": "${GITHUB_RUN_ID}",
            "sha": "${{ steps.imagetag.outputs.short_sha }}"
          }
          EOF

      - name: Upload image metadata
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-image-${{ steps.request.outputs.issue_number }}-meta
          path: ci-image.json
          retention-days: 2

      - name: Upload image part 00
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-image-${{ steps.request.outputs.issue_number }}-part-00
          path: galaxy-image.tar.part-00
          retention-days: 2

      - name: Upload image part 01
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-image-${{ steps.request.outputs.issue_number }}-part-01
          path: galaxy-image.tar.part-01
          retention-days: 2

      - name: Upload image part 02
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-image-${{ steps.request.outputs.issue_number }}-part-02
          path: galaxy-image.tar.part-02
          retention-days: 2

      - name: Upload image part 03
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-image-${{ steps.request.outputs.issue_number }}-part-03
          path: galaxy-image.tar.part-03
          retention-days: 2

      - name: Comment with build instructions
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const runId = process.env.GITHUB_RUN_ID;
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${runId}`;
            const imageTag = '${{ steps.imagetag.outputs.image_tag }}';
            const artifactPrefix = `galaxy-image-${issueNumber}-part-`;
            const parts = ['00', '01', '02', '03'];
            const downloads = parts.map((p) => `gh run download ${runId} -n ${artifactPrefix}${p}`).join('\n');

            const body = [
              'Build completed for the requested Galaxy source:',
              `- Source: ${{ steps.request.outputs.url }}`,
              `- Run: ${runUrl}`,
              '',
              'Download and reassemble:',
              '```bash',
              downloads,
              'cat galaxy-image.tar.part-* > galaxy-image.tar',
              'docker load -i galaxy-image.tar',
              `docker run --rm -p 8080:80 ${imageTag}`,
              '```',
              '',
              'Note: artifacts are retained for 48 hours.',
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body,
            });

      - name: Create PR for non-maintainers
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized != 'true'
        id: botpr
        run: |
          set -euo pipefail
          issue_number="${{ steps.request.outputs.issue_number }}"
          repo="${{ steps.buildargs.outputs.galaxy_repo }}"
          release="${{ steps.buildargs.outputs.galaxy_release }}"
          url_hash="$(printf '%s' '${{ steps.request.outputs.url }}' | sha256sum | cut -c1-7)"
          branch="bot/galaxy-source-issue-${issue_number}-${url_hash}"
          if git ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
            branch="${branch}-$(date +%s)"
          fi
          git checkout -b "$branch"
          python - <<'PY'
          from pathlib import Path
          import re

          dockerfile = Path('galaxy/Dockerfile')
          text = dockerfile.read_text()
          repo = "${{ steps.buildargs.outputs.galaxy_repo }}"
          release = "${{ steps.buildargs.outputs.galaxy_release }}"

          text = re.sub(r'^ARG GALAXY_REPO=.*$', f'ARG GALAXY_REPO={repo}', text, flags=re.M)
          text = re.sub(r'^ARG GALAXY_RELEASE=.*$', f'ARG GALAXY_RELEASE={release}', text, flags=re.M)
          dockerfile.write_text(text)
          PY
          if git diff --quiet -- galaxy/Dockerfile; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "branch=$branch" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add galaxy/Dockerfile
          git commit -m "Update Galaxy source to ${repo} (${release})"
          git push origin "$branch"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "no_changes=false" >> "$GITHUB_OUTPUT"

      - name: Open PR for non-maintainers
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized != 'true' && steps.botpr.outputs.no_changes != 'true'
        id: botpr_open
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const branch = '${{ steps.botpr.outputs.branch }}';
            const base = '${{ steps.request.outputs.base_branch }}';
            const title = `Update Galaxy source for issue #${issueNumber}`;
            const body = [
              'Requested Galaxy source update:',
              `- Source: ${{ steps.request.outputs.url }}`,
              '',
              'This PR updates `galaxy/Dockerfile` to use the requested Galaxy fork and ref.',
            ].join('\n');

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: `${owner}:${branch}`,
              base,
              body,
            });
            core.setOutput('pr_url', pr.data.html_url);

      - name: Comment with PR link
        if: steps.request.outputs.requested == 'true' && steps.request.outputs.authorized != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const prUrl = '${{ steps.botpr_open.outputs.pr_url }}';
            const noChanges = '${{ steps.botpr.outputs.no_changes }}' === 'true';
            let body;
            if (noChanges) {
              body = 'No PR created: `galaxy/Dockerfile` already matches the requested Galaxy source.';
            } else {
              body = [
                'Created a PR to update the Galaxy source for this request:',
                prUrl,
              ].join('\\n');
            }
            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body });
