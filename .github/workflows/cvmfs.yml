name: cvmfs-sidecar
on:
  push:
    branches:
      - '**'
    tags:
      - '*'
  pull_request:
    paths:
      - 'cvmfs/**'
      - 'test/cvmfs/**'
      - '.github/workflows/cvmfs.yml'

jobs:
  build_test_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect CVMFS changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            cvmfs:
              - 'cvmfs/**'
              - 'test/cvmfs/**'
              - '.github/workflows/cvmfs.yml'

      - name: Run CVMFS sidecar tests
        if: github.event_name == 'pull_request' || steps.changes.outputs.cvmfs == 'true' || startsWith(github.ref, 'refs/tags/')
        run: bash test/cvmfs/test.sh

      - name: Set image version
        id: version
        if: github.event_name == 'push' && (steps.changes.outputs.cvmfs == 'true' || startsWith(github.ref, 'refs/tags/'))
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            version="${GITHUB_REF_NAME}"
          else
            ref="${GITHUB_REF_NAME//\//-}"
            version="${ref}-${GITHUB_SHA::7}"
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        if: github.event_name == 'push' && (steps.changes.outputs.cvmfs == 'true' || startsWith(github.ref, 'refs/tags/'))
        uses: docker/setup-buildx-action@v3

      - name: Login to Quay IO
        if: github.event_name == 'push' && (steps.changes.outputs.cvmfs == 'true' || startsWith(github.ref, 'refs/tags/'))
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: '$oauthtoken'
          password: ${{ secrets.QUAY_OAUTH_TOKEN }}

      - name: Build and push CVMFS image
        if: github.event_name == 'push' && (steps.changes.outputs.cvmfs == 'true' || startsWith(github.ref, 'refs/tags/'))
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:cvmfs"
          push: true
          tags: quay.io/bgruening/cvmfs:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
